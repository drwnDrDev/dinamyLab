const u={PACIENTE:"Paciente",NUEVO_USUARIO:"nuevoUsuario",ACTUALIZAR_USUARIO:"actualizarUsuario"},p={tiposDocumento:"tipos_documento_data",paises:"paises_data",municipios:"municipios_data",eps:"eps_data"};JSON.parse(localStorage.getItem(p.tiposDocumento)).pacientes;const b=JSON.parse(localStorage.getItem(p.paises))||[],v=JSON.parse(localStorage.getItem(p.municipios))||[],C=JSON.parse(localStorage.getItem(p.eps))||[];document.getElementById("crearPaciente");document.getElementById("crearacompaniante");const f=document.getElementById("paciente_id"),E=document.getElementById("acompaniante_id"),h=document.querySelector('meta[name="csrf-token"]').getAttribute("content"),x=document.getElementById("16000"),L=document.getElementById("busquedaExamen");axios.get("/api/examenes",{headers:{"X-CSRF-TOKEN":h,Accept:"application/json"}}).then(e=>{const n=e.data.data.examenes||[];let a=n;g(a),x.addEventListener("change",t=>{t.target.checked?a=n.filter(r=>parseFloat(r.valor)===16e3):a=n,g(a)}),L.addEventListener("input",t=>{const r=t.target.value.toLowerCase();r.length>2?a=n.filter(o=>o.nombre.toLowerCase().includes(r)):a=n,g(a)})}).catch(e=>(console.error("Error al obtener los exámenes:",e),[]));const A=e=>e.reduce((n,a)=>n+(a.currenTotal||0),0),g=e=>{const n=document.getElementById("examenesContainer");let a=0;n.innerHTML="",e.forEach(t=>{const r=document.createElement("div");r.className="examen-item flex items-center gap-2 p-2 border border-borders rounded-sm shadow-sm";const o=document.createElement("input");o.type="number",o.id=t.id,o.name=`examenes[${t.id}]`,o.className="w-16 px-2 py-1 text-center rounded border border-borders bg-white focus:outline-none focus:ring-2 focus:ring-primary appearance-none",o.min="0",o.value=t.cantidad||"0",o.step="integer",o.style.cssText="appearance: textfield; -moz-appearance: textfield;",o.addEventListener("input",c=>{const l=parseInt(c.target.value,10);isNaN(l)||l<0?c.target.value="0":c.target.value=l.toString()}),o.addEventListener("blur",c=>{t.cantidad=parseInt(c.target.value,10),(isNaN(t.cantidad)||t.cantidad<0)&&(c.target.value="0"),t.currenTotal=t.valor*t.cantidad;const l=document.getElementById(`precio-${t.id}`);l.classList.add("text-gray-900","dark:text-gray-100"),l.textContent=`$ ${t.currenTotal.toFixed(2)}`;const m=document.getElementById("totalExamenes");a=A(e),m.textContent=`Total: $ ${a.toFixed(2)}`});const s=document.createElement("div");s.className="grid ",r.appendChild(s);const i=document.createElement("label");i.setAttribute("for",t.id),i.className="text-lg font-semibold",i.textContent=t.nombre;const d=document.createElement("span");t.currenTotal!==void 0?(d.className="text-sm text-gray-9000 dark:text-gray-100 precio",d.textContent=`$ ${t.currenTotal.toFixed(2)}`):(d.className="text-sm text-gray-500 dark:text-gray-400 precio",d.textContent=`$ ${parseFloat(t.valor).toFixed(2)}`),d.id=`precio-${t.id}`,s.appendChild(i),s.appendChild(d),r.appendChild(o),n?n.appendChild(r):boddy.appendChild(r)})},y=e=>{e.preventDefault();const n=e.target,a=new FormData(n),t=a.get("perfil")===u.PACIENTE;let r="/api/personas";n.tipoGuardado.value===u.ACTUALIZAR_USUARIO&&(r=t?`/api/personas/${f.value}`:`/api/personas/${E.value}`,a.append("_method","PUT")),axios.post(r,a,{headers:{"X-CSRF-TOKEN":h,"Content-Type":"multipart/form-data",Accept:"application/json"}}).then(o=>{const s=o.data.data;t?f.value=s.id:E.value=s.id,Array.from(n.elements).forEach(i=>{i.type!=="hidden"&&(i.setAttribute("disabled","disabled"),i.classList.add("bg-stone-300","dark:bg-gray-700","cursor-not-allowed"))}),n.classList.add("bg-green-100","pointer-events-none","transition","duration-50","ease-in-out"),n.querySelector('button[type="submit"]').classList.add("bg-green-600","text-white","cursor-not-allowed"),n.querySelector('button[type="submit"]').textContent="Guardado exitoso",n.querySelector('button[type="submit"]').disabled=!0}).catch(o=>{if(o.response?.status===422){console.warn("Errores de validación:",o.response.data.errors);const s=o.response.data.errors,i=Object.values(s).flat(),d=document.createElement("ul");i.forEach(l=>{const m=document.createElement("li");m.textContent=l,d.appendChild(m)});const c=document.createElement("div");c.classList.add("text-sm","text-red-600","space-y-1"),c.appendChild(d),n.appendChild(c),setTimeout(()=>{c.remove()},5e3)}else o.response?console.error("Error en la solicitud:",o.response.data):console.error("Error desconocido:",o)})},I=e=>{e.preventDefault();const n="/api/personas/buscar/",a=e.target.form.numero_documento.value;if(a.length>3){const t=n+a;axios.get(t).then(r=>{if(r.data&&r.data.data){const o=r.data.data;if(e.target.form.tipoGuardado.value=u.ACTUALIZAR_USUARIO,e.target.form.tipoGuardado.textContent="Actualizar usuario",e.target.form.numero_documento.value=o.numero_documento,e.target.form.tipo_documento.value=o.tipo_documento,e.target.form.nombres.value=o.nombre,e.target.form.apellidos.value=o.apellido,o.pais){const s=b.find(d=>d.codigo_iso===o.pais),i=document.createElement("option");i.value=s.codigo_iso,i.textContent=s.nombre,i.className=["text-gray-900","dark:text-gray-100"],e.target.form.pais.appendChild(i),e.target.form.pais.value=o.pais||"COL"}e.target.form.perfil.value===u.PACIENTE?(f.value=o.id,e.target.form.fecha_nacimiento.value=o.fecha_nacimiento,e.target.form.direccion.value=o.direccion,e.target.form.telefono.value=o.telefono,e.target.form.correo.value=o.correo,e.target.form.sexo.forEach(s=>{s.value===o.sexo&&(s.checked=!0)}),e.target.form.municipio.value=o.municipio,e.target.form.municipioBusqueda.value=o.ciudad||"",e.target.form.eps.value=o.eps||""):E.value=o.id}else e.target.form.tipoGuardado.value=u.NUEVO_USUARIO,e.target.form.tipoGuardado.textContent="Usuario nuevo"}).catch(r=>{console.error("Error fetching persona:",r)})}};document.getElementById("crearPaciente").addEventListener("submit",function(e){y(e)});document.getElementById("crearacompaniante").addEventListener("submit",function(e){y(e)});document.getElementsByName("numero_documento").forEach(e=>{e.addEventListener("blur",function(n){I(n)})});document.getElementsByName("tipo_documento").forEach(e=>{e.addEventListener("change",function(n){const a=e.value,t=n.target.form.pais,r=n.target.form.numero_documento;a==="CC"||a==="RC"||a==="TI"||a==="CE"?(r.setAttribute("maxlength","10"),r.setAttribute("placeholder","Número de documento"),t.value="COL",t.setAttribute("disabled","disabled")):(a==="PA"||a==="PP"||a==="PE"||a==="PS"||a==="PT"||a==="AS"||a==="MS")&&(r.setAttribute("maxlength","16"),r.setAttribute("placeholder","Identificación temporal"),r.setAttribute("type","text"),t.removeAttribute("disabled"),t.addEventListener("focus",function(o){b.forEach(s=>{const i=document.createElement("option");i.value=s.codigo_iso,i.textContent=s.nombre,i.className=["text-gray-900","dark:text-gray-100"],t.appendChild(i)})},{once:!0}))})});document.getElementsByName("municipioBusqueda").forEach((e,n)=>{let a=e.form.querySelector('select[name="municipio"]');a||(a=document.createElement("select"),a.className="hidden",e.form.appendChild(a)),a.innerHTML="",v.forEach(s=>{const i=document.createElement("option");i.value=s.id,i.textContent=s.municipio+" - "+s.departamento,a.appendChild(i)});let t=e.form.querySelector(".municipio-autocomplete-list");t||(t=document.createElement("div"),t.className="municipio-autocomplete-list absolute z-10 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded w-full max-h-48 overflow-auto hidden",e.parentNode.appendChild(t));function r(s){const i=v.filter(d=>(d.municipio+" - "+d.departamento).toLowerCase().includes(s.toLowerCase()));o(i)}function o(s){t.innerHTML="",s.length>0?(s.forEach(i=>{const d=document.createElement("div");d.className="p-2 cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700 capitalize",d.textContent=i.municipio+" - "+i.departamento,d.addEventListener("mousedown",()=>{e.value=d.textContent,a.value=i.id,t.classList.add("hidden")}),t.appendChild(d)}),t.classList.remove("hidden")):t.classList.add("hidden")}e.setAttribute("autocomplete","off"),e.addEventListener("input",()=>{r(e.value)}),e.addEventListener("focus",()=>{r(e.value)}),e.addEventListener("blur",()=>{setTimeout(()=>{t.classList.add("hidden")},150)})});document.getElementsByName("eps").forEach(e=>{const n=e.getAttribute("list");if(n){const a=document.getElementById(n);a&&(a.innerHTML="",C.forEach(t=>{const r=document.createElement("option");r.value=t.nombre,a.appendChild(r)}))}});
