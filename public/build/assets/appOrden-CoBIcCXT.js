import{R as e,r as m}from"./index-C2KC86Ta.js";import{c as j}from"./client-DCM6oUEP.js";import{u as q,S as _,F as R}from"./FormPersona-PTjjp6o9.js";import{a as I}from"./index-B9ygI19o.js";import{u as T}from"./useAxiosAuth-JGr_IZ3E.js";const L=()=>e.createElement("div",{className:"fixed inset-0 flex justify-center items-center h-full z-50 bg-white bg-opacity-90"},e.createElement("div",{className:"text-center"},e.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6 text-green-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2},e.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M5 13l4 4L19 7"})),e.createElement("p",{className:"mt-2 text-lg font-medium text-gray-800"},"Completado"))),z=()=>{const[t,s]=m.useState([]),[n,u]=m.useState(!0);return m.useEffect(()=>{(async()=>{try{const r=await I.get("/api/examenes");s(r.data||[])}catch(r){console.error("Error al cargar ex√°menes",r)}finally{u(!1)}})()},[]),{examenes:t,loading:n}},V=({examenes:t,onRemove:s,onCantidadChange:n,onChangeValores:u})=>{console.log("TablaExamenes - examenes recibidos:",t);const[c,r]=m.useState(0),[o,l]=m.useState(0),[a,h]=m.useState(!1),[x,w]=m.useState(!1);if(!Array.isArray(t))return console.error("TablaExamenes: examenes no es un array"),null;const S=p=>{const E=parseFloat(p.target.value);r(isNaN(E)?0:E)},b=p=>{const E=parseFloat(p.target.value);l(isNaN(E)?0:E)},f=p=>typeof p=="number"?p:typeof p=="string"&&parseFloat(p)||0,i=t.reduce((y,D)=>{const F=D.cantidad||1,A=f(D.valor);return y+F*A},0)-(x?o:0),N=a?i-c:i;return console.log("valor State abono:",c),console.log("valor State descuento:",o),console.log("valor total antes de abono y descuento:",i),m.useEffect(()=>{console.log("useEffect - Valores actualizados:",{total:i,abono:c,descuento:o,saldo:N}),u("total",i),u("abono",a?c:0)},[i,c,o,N,a,x]),e.createElement("div",{className:"overflow-x-auto"},e.createElement("table",{className:"w-full mt-4"},e.createElement("thead",{className:"bg-gray-50"},e.createElement("tr",null,e.createElement("th",{className:"px-4 py-2 text-left"},"C√≥digo"),e.createElement("th",{className:"px-4 py-2 text-left"},"Nombre"),e.createElement("th",{className:"px-4 py-2 text-left"},"Cantidad"),e.createElement("th",{className:"px-4 py-2 text-right"},"Valor U."),e.createElement("th",{className:"px-4 py-2 text-right"},"Subtotal"),e.createElement("th",{className:"px-4 py-2"}))),e.createElement("tbody",null,t.map((p,E)=>p?e.createElement("tr",{key:E,className:"border-b hover:bg-gray-50"},e.createElement("td",{className:"px-4 py-2"},p.cup||"N/A"),e.createElement("td",{className:"px-4 py-2"},p.nombre||"Sin nombre"),e.createElement("td",{className:"p-2"},e.createElement("input",{type:"number",min:"1",value:p.cantidad||1,onChange:y=>n(E,parseInt(y.target.value)||1),className:"w-20 px-2 py-1 border rounded focus:outline-none focus:ring-1 focus:ring-primary"})),e.createElement("td",{className:"px-4 py-2 text-right"},"$",f(p.valor).toFixed(2)),e.createElement("td",{className:"px-4 py-2 text-right"},"$",((p.cantidad||1)*f(p.valor)).toFixed(2)),e.createElement("td",{className:"px-4 py-2 text-center"},e.createElement("button",{onClick:()=>s(E),className:"text-red-500 hover:text-red-700"},"‚ùå"))):(console.warn(`Examen en √≠ndice ${E} es null o undefined`),null))),e.createElement("tfoot",null,a&&e.createElement("tr",{className:`border-t-2 border-gray-200 font-semibold ${c>i?"text-red-600":""}`},e.createElement("td",{colSpan:"4",className:"px-4 py-3 text-right"},"Abono:"),e.createElement("td",{className:"px-4 py-3 text-right"},e.createElement("input",{type:"number",onChange:S})),e.createElement("td",null)),a&&e.createElement("tr",{className:"border-t-2 border-gray-200 font-semibold"},e.createElement("td",{colSpan:"4",className:"px-4 py-3 text-right"},"Saldo:"),e.createElement("td",{className:"px-4 py-3 text-right"},"$",N.toFixed(2)),e.createElement("td",null)),x&&e.createElement("tr",{className:"border-t-2 border-gray-200 font-semibold"},e.createElement("td",{colSpan:"4",className:"px-4 py-3 text-right"},"Descuento:"),e.createElement("td",{className:"px-4 py-3 text-right"},e.createElement("input",{type:"number",onChange:b})),e.createElement("td",null)),e.createElement("tr",{className:`border-t-2 border-gray-200 font-semibold ${x&&o>i?"text-red-600":""}`},e.createElement("td",{colSpan:"4",className:"px-4 py-3 text-right"},"Total:"),e.createElement("td",{className:"px-4 py-3 text-right"},"$",i.toFixed(2)),e.createElement("td",null)))),e.createElement("div",null,e.createElement("button",{onClick:()=>w(!x)},"Descuento"),e.createElement("button",{onClick:()=>h(!a)},"Abono")))},B=({disponibles:t,onAgregar:s,examenesActuales:n,onClose:u,sexoPaciente:c})=>{const r=new Set(n.map(a=>a.id)),[o,l]=m.useState(t);return e.useEffect(()=>{l(c==="M"?t.filter(a=>a.sexo_aplicable!=="F"):c==="F"?t.filter(a=>a.sexo_aplicable!=="M"):t)},[c,t]),console.log('ModalExamenes - Ex√°menes "disponibles":',t),e.createElement("div",{className:"fixed inset-0 flex items-center justify-center z-50"},e.createElement("div",{className:"modal border border-secondary shadow-lg p-4 bg-white rounded-lg w-full max-w-2xl"},e.createElement("h3",{className:"text-xl font-semibold mb-4"},"Seleccionar Ex√°menes"),e.createElement("div",{className:"max-h-[60vh] overflow-y-auto"},e.createElement("ul",{className:"space-y-2"},o.map(a=>e.createElement("li",{key:a.id,className:"flex items-center justify-between p-2 hover:bg-gray-50 rounded"},e.createElement("div",null,e.createElement("span",{className:"mr-2"},a.cup),e.createElement("span",{className:"mr-2"},a.nombre),e.createElement("span",null,"$",a.valor)),e.createElement("button",{disabled:r.has(a.id),onClick:()=>s(a),className:`px-3 py-1 rounded ${r.has(a.id)?"bg-gray-200 text-gray-500":"bg-primary text-white"}`},r.has(a.id)?"Agregado":"Agregar"))))),e.createElement("div",{className:"mt-4 flex justify-end"},e.createElement("button",{onClick:u,className:"px-4 py-2 text-gray-600 hover:text-gray-800"},"Cerrar"))))},J=({formExamenes:t,onUpdate:s,persona:n,onChangeValores:u})=>{const{examenes:c}=z(),r=c?.data||[],[o,l]=m.useState(!1),[a,h]=m.useState(n?.sexo||"A"),x=b=>{t.some(i=>i.id===b.id)||s([...t,{...b,cantidad:1}])},w=b=>{const f=[...t];f.splice(b,1),s(f)},S=(b,f)=>{if(f<1)return;const i=[...t];i[b]={...i[b],cantidad:f},s(i)};return console.log("Ex√°menes disponibles, desde localStorage var=disponibles:",r),console.log("Ex√°menes en el formulario, prop formExamenes:",t),e.createElement("section",null,e.createElement("h2",null,"Ex√°menes"),e.createElement("button",{className:"bg-secondary",onClick:()=>l(!0)},"Agregar examen"),t.length===0&&e.createElement("p",null,"No hay ex√°menes seleccionados."),t.length>0&&e.createElement(V,{examenes:t,onRemove:w,onCantidadChange:S,onChangeValores:u}),o&&e.createElement(B,{disponibles:r,examenesActuales:t,onAgregar:x,onClose:()=>l(!1),sexoPaciente:a}))},Y=({persona:t})=>{if(!t)return console.warn("DatosPersona: No se proporcion√≥ el objeto persona"),null;const s=n=>{try{if(!n)return"No especificada";const u=new Date,c=new Date(n);if(isNaN(c.getTime()))return console.warn("Fecha de nacimiento inv√°lida:",n),"Fecha inv√°lida";let r=u.getFullYear()-c.getFullYear();const o=u.getMonth()-c.getMonth();return(o<0||o===0&&u.getDate()<c.getDate())&&r--,r<0||r>150?(console.warn("Edad calculada fuera de rango:",r),"Edad fuera de rango"):`${r} a√±os`}catch(u){return console.error("Error al calcular la edad:",u),"Error al calcular edad"}};return console.log("Renderizando DatosPersona con:",t),t?e.createElement("section",{className:"print_paciente grid grid-cols-2 py-2 border-t-[0.2px] border-b-[0.2px] border-borders w-full"},e.createElement("div",{className:"col-span-2 flex gap-2"},e.createElement("span",{className:"font-normal"},"Paciente: "),e.createElement("h3",{className:"text-titles font-normal"},`${t.primer_nombre||""} ${t.primer_apellido||""} ${t.segundo_nombre||""} ${t.segundo_apellido||""}`)),e.createElement("div",{className:"w-full grid grid-cols-[auto_1fr] gap-x-4 gap-y-0"},e.createElement("span",{className:"font-normal"},"Identificaci√≥n: "),e.createElement("h3",{className:"text-titles font-light"},`${t.tipo_documento?.cod_rips||""} ${t.numero_documento||""}`),e.createElement("span",{className:"font-normal"},"Sexo: "),e.createElement("h3",{className:"text-titles font-light"},(()=>{const n=t.sexo;return n?{M:"Masculino",F:"Femenino",I:"Intersexual"}[n]||"Otro":"No especificado"})()),e.createElement("span",{className:"font-normal"},"Edad: "),e.createElement("h3",{className:"text-titles font-light"},t.fecha_nacimiento?s(t.fecha_nacimiento):"No especificada")),e.createElement("div",{className:"grid grid-cols-[auto_1fr] gap-x-4 gap-y-0"},e.createElement("span",{className:"font-normal"},"Fecha de atenci√≥n: "),e.createElement("h3",{className:"text-titles font-light"},new Date().toLocaleDateString("es-CO")),e.createElement("span",{className:"font-normal"},"Fecha de Nacimiento: "),e.createElement("h3",{className:"text-titles font-light"},t.fecha_nacimiento?new Date(t.fecha_nacimiento).toLocaleDateString("es-CO"):"No especificada"))):(console.warn("DatosPersona: persona es null o undefined"),null)},G=()=>{const[t,s]=m.useState({cie10:[],cups:[]});return m.useEffect(()=>{(async()=>{const u=async(o,l)=>{let a=JSON.parse(localStorage.getItem(o))||[];if(a.length===0)try{a=(await I.get(l)).data||[],localStorage.setItem(o,JSON.stringify(a))}catch(h){console.error(`Error al cargar ${o}`,h)}return a},c=await u("default_cies_data","/api/cie10"),r=await u("cups_data","/api/cups");s({cie10:c,cups:r})})()},[]),t},H=({formOrden:t,onUpdate:s,error:n})=>{const{modalidades:u,finalidades:c,viasIngreso:r,servicios:o}=q(),{cie10:l}=G();return e.createElement("section",null,e.createElement("h2",null,"Datos de la Orden"),e.createElement("div",{className:"grid grid-cols-2 gap-4"},e.createElement(_,{label:"Modalidad de Atenci√≥n",name:"modalidad",value:t.modalidad||"",codigo:!0,options:u,onChange:s,error:n?.modalidad}),e.createElement(_,{label:"Servicio Habilitado",name:"cod_servicio",value:t.cod_servicio||"",codigo:!0,options:o,onChange:s,error:n?.cod_servicio}),e.createElement(_,{label:"CIE Principal",name:"cie_principal",value:t.cie_principal||"",codigo:!0,options:l,onChange:s,error:n?.cie_principal}),e.createElement(_,{label:"CIE Relacionado",name:"cie_relacionado",value:t.cie_relacionado||"",codigo:!0,options:l,onChange:s,error:n?.cie_relacionado}),e.createElement(_,{label:"Finalidad de Consulta",name:"finalidad",value:t.finalidad||"",codigo:!0,options:c,onChange:s,error:n?.finalidad}),e.createElement(_,{label:"V√≠a de Ingreso",name:"via_ingreso",value:t.via_ingreso||"",codigo:!0,options:r,onChange:s,error:n?.via_ingreso})))},W={cod_servicio:706,via_ingreso:"01",cie_principal:null,cie_relacionado:null,finalidad:"16",modalidad:"01"},k={numero_orden:{required:!0,validate:t=>/^[1-9]\d{0,4}$/.test(t),message:"Debe ser un n√∫mero positivo de 1 a 5 d√≠gitos (sin ceros al inicio)"},paciente_id:{required:!0,validate:t=>t!==null&&t>0,message:"Debe seleccionar un paciente v√°lido"},examenes:{required:!0,validate:t=>t.length!==0,message:"Debe seleccionar al menos un examen"},cod_servicio:{required:!0,message:"Debe seleccionar un servicio v√°lido"},via_ingreso:{required:!0,message:"Debe seleccionar una v√≠a de ingreso v√°lida"},cie_principal:{required:!0,message:"El diagn√≥stico principal es obligatorio"},finalidad:{required:!0,message:"Debe seleccionar una finalidad v√°lida"},modalidad:{required:!0,message:"Debe seleccionar una modalidad v√°lida"},abono:{required:!1,validate:t=>t<=total,message:"El abono no puede exceder el total"},total:{required:!0,validate:t=>t>=0,message:"El total no puede ser negativo"}};function K(){const[t,s]=m.useState({}),n=(r,o)=>{const l=k[r];return l&&l.required?l.validate?l.validate(o):o!==null&&o!==""&&o!==void 0:!0};return{errors:t,validateForm:r=>{const o={};let l=!0;return Object.keys(k).forEach(a=>{const h=r[a],x=k[a];n(a,h)||(o[a]=x.message,l=!1)}),s(o),l},validateField:n,clearError:r=>{s(o=>({...o,[r]:""}))}}}const Q=(t,{dataDefoult:s=W}={})=>{const{axiosInstance:n,csrfLoaded:u}=T(),[c,r]=m.useState(null);m.useEffect(()=>{(async()=>{try{const d=await n.get("/api/ordenes/max-numero");d.status===200?(r(d.data.next_numero),console.log("‚úÖ Siguiente n√∫mero de orden obtenido:",d.data.next_numero)):console.error("‚ùå Error al obtener el siguiente n√∫mero de orden, estado:",d.status)}catch(d){console.error("‚ùå Error al obtener el siguiente n√∫mero de orden:",d)}})()},[n]);const o={numero_orden:c||"",paciente_id:null,examenes:[],cod_servicio:null,via_ingreso:"",cie_principal:null,cie_relacionado:null,finalidad:"",modalidad:"",abono:0,total:0,fecha_orden:new Date().toISOString().split("T")[0]+" "+new Date().toTimeString().slice(0,5)},[l,a]=m.useState(t.paciente||null),[h,x]=m.useState(!1),[w,S]=m.useState(!1),[b,f]=m.useState(null),[i,N]=m.useState(o),{validateForm:p,errors:E,clearError:y}=K();console.log("datos recibidos de paciente:",t),m.useEffect(()=>{l&&N(g=>{const d={...g,paciente_id:l.id||null};return console.log("üìù Estado del formulario actualizado:",d),d})},[l]),m.useEffect(()=>{c!==null&&(N(g=>({...g,numero_orden:c})),console.log("‚úÖ numero_orden actualizado en el formulario:",c))},[c]),m.useEffect(()=>{if(s&&Object.keys(s).length>0){const{cod_servicio:g,via_ingreso:d,cie_principal:C,cie_relacionado:$,finalidad:M,modalidad:P}=s;N(v=>({...v,cod_servicio:g||v.cod_servicio,via_ingreso:d||v.via_ingreso,cie_principal:C||v.cie_principal,cie_relacionado:$||v.cie_relacionado,finalidad:M||v.finalidad,modalidad:P||v.modalidad}))}},[]),console.log("üìù Estado del formulario despu√©s de aplicar datos por defecto:",i);const D=g=>{if(console.log("üîÑ Actualizando persona:",g),!g){console.error("Error: nuevaPersona es null o undefined");return}const d=g?.data||g;if(!d.id){console.error("Error: La persona no tiene ID");return}a(d)},F=g=>{const{name:d,value:C}=g.target;N($=>({...$,[d]:C})),y(d)},A=(g,d)=>{N(C=>({...C,[g]:d})),y(g)},O=async g=>{if(g.preventDefault(),!u){f("‚è≥ Autenticaci√≥n en progreso...");return}if(console.log("Validando orden:",i),!p(i)){console.log("Errores de validaci√≥n:",E),alert("Por favor complete todos los campos obligatorios");return}x(!0),f(null);try{if(!i.paciente_id){f("Por favor, seleccione un paciente.");return}if(i.examenes.length===0){f("Por favor, seleccione al menos un examen.");return}const d=await n.post("/api/ordenes",i);S(!0),d?.data?.data?.id&&(window.location.href=`/ordenes-medicas/${d.data.data.id}/ver`)}catch(d){f(d.response?.data?.message||"Error al crear la orden")}finally{x(!1)}};return b?e.createElement("div",{className:"text-red-600"},"Error: ",b):e.createElement(e.Fragment,null,w&&e.createElement(L,null),e.createElement("div",{className:"crear-orden-wrapper relative"},e.createElement("div",{className:"header max-w-5xl mx-2 lg:mx-auto sm:p-2 md:p-4 lg:p-8"},e.createElement("h1",{className:"text-2xl font-bold text-titles mb-4"},"Crear Nueva Orden"),e.createElement("label",{htmlFor:"numero_orden",className:"text-xl pr-4"},"Numero de Orden: "),e.createElement("input",{type:"number",onChange:F,name:"numero_orden",value:i.numero_orden,className:`h-9 w-32 p-2 border-borders focus:border-primary focus:ring-primary rounded-md ${E.numero_orden?"border-red-500":""}`}),E.numero_orden&&e.createElement("p",{className:"mt-1 text-sm text-red-600"},E.numero_orden)),e.createElement("section",{className:"paciente_container max-w-5xl mx-2 lg:mx-auto sm:p-2 md:p-4 lg:p-8 bg-background rounded-xl border border-secondary shadow-md mb-4"},l?e.createElement(e.Fragment,null,e.createElement(Y,{persona:l}),e.createElement("div",{className:"mt-4 flex justify-end"},e.createElement("button",{onClick:()=>a(null),className:"px-4 py-2 text-sm text-gray-600 hover:text-primary"},"Cambiar paciente"))):e.createElement(R,{persona:l,setPersona:D,perfil:"Paciente"})),l&&e.createElement("section",{className:"examenes_container max-w-5xl mx-2 lg:mx-auto sm:p-2 md:p-4 lg:p-8 bg-background rounded-xl border border-secondary shadow-md mb-4"},e.createElement(J,{formExamenes:i.examenes,onUpdate:g=>N(d=>({...d,examenes:g})),persona:l,onChangeValores:A})),i.examenes.length>0&&e.createElement("section",{className:"resumen_container max-w-5xl mx-2 lg:mx-auto sm:p-2 md:p-4 lg:p-8 bg-background rounded-xl border border-secondary shadow-md mb-4"},e.createElement(H,{formOrden:i,onUpdate:F,error:E})),e.createElement("div",{className:"flex justify-end px-4 py-2 max-w-5xl mx-2 lg:mx-auto sm:p-2 md:p-4 lg:p-8"},e.createElement("button",{type:"button",onClick:O,disabled:h,className:"inline-flex items-center justify-center rounded-md border border-transparent bg-primary py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-titles focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 disabled:opacity-50"},h?e.createElement(e.Fragment,null,e.createElement("div",{className:"animate-spin mr-2 h-4 w-4 border-b-2 border-white rounded-full"}),h?"Actualizando...":"Guardando..."):"Nueva Orden"))))};if(document.getElementById("react-crear-orden")){const t=document.getElementById("react-crear-orden"),s=JSON.parse(t.getAttribute("data-persona"))??null;j.createRoot(t).render(e.createElement(Q,{paciente:s}))}
